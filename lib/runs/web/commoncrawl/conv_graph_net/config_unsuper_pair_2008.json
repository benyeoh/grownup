[
    {
        "cache": {
            "value_matched_weights": {
                "ktf.models.losses.ValueMatchWeights": {
                    "value_spec": { 
                        "dict": {
                            "match": [
                                [0.11385568231344223, 0.0343981608748436, -0.006175319664180279, 0.004899680148810148, -0.02247696928679943, 0.018767530098557472, 0.03151082620024681, 0.04643234983086586, -0.0024589926470071077, -0.0026043958496302366, -0.00988566130399704, -0.03863797336816788, 0.08020848035812378, -0.04236093536019325, -0.0879950076341629, -0.05009472742676735, 0.015844937413930893, 0.1074572429060936, 0.03054671175777912, 0.09133077412843704, -0.03357430547475815, 0.11380141228437424, 0.046038903295993805, -0.014919137582182884, 0.06770133227109909, -0.0160539411008358, 0.05095189809799194, -0.05162498727440834, -0.025407642126083374, 0.0055443961173295975, 0.029900318011641502, 0.035107821226119995, 0.057383954524993896, -0.035775233060121536, 0.0023739966563880444, -0.08188848197460175, -0.018260860815644264, -0.01681170053780079, 0.028970172628760338, -0.053918417543172836, 0.04428718984127045, -0.04831526428461075, -0.03955746814608574, -0.053662896156311035, 0.01699204370379448, 0.0735040158033371, 0.046017806977033615, 0.008313624188303947, 0.034484077244997025, 0.015027336776256561, 0.056786954402923584, -0.031159603968262672, 0.034105002880096436, -0.04817662388086319, -0.02023937739431858, -0.1138477623462677, -0.027956558391451836, 0.07097291946411133, 0.0675901398062706, 0.008107012137770653, 0.0308989305049181, 0.012378928251564503, -0.01926339976489544, 0.011931261979043484, -0.032174259424209595, 0.0056121633388102055, 0.02029816247522831, -0.002305871108546853, -0.02795804850757122, 0.033474404364824295, 0.026377322152256966, 0.008586431853473186, -0.01128199603408575, -0.02233249694108963, -0.037146855145692825, 0.04830048978328705, 0.029021957889199257, 0.010194637812674046, 0.025284426286816597, 0.1090230718255043, -0.11216826736927032, -0.023279020562767982, -0.019458387047052383, -0.028097284957766533, -0.003213485237210989, -0.017228178679943085, -0.08666226267814636, 0.019352978095412254, 0.03970344737172127, 0.07442370802164078, -0.0017555714584887028, -0.08542942255735397, -0.037207767367362976, 0.037326276302337646, 0.06231016665697098, -0.04881922900676727, -0.03427869826555252, 0.041244328022003174, -0.007134283892810345, -0.015762032940983772, -0.008310982026159763, -0.05548439547419548, 0.04555097594857216, -0.0011364234378561378, -0.04882025718688965, -0.05095842853188515, -0.06579684466123581, -0.03151974454522133, -0.03831372410058975, -0.043716028332710266, 0.012052682228386402, 0.06806977838277817, -0.006242075003683567, -0.0306903924793005, -0.028888849541544914, -0.014019779860973358, -0.031139841303229332, -0.007238989695906639, 0.052210256457328796, -0.019689122214913368, -0.02298550121486187, 0.014872532337903976, 0.03691171482205391, 0.022594986483454704, -0.03604178503155708, -0.023587090894579887, 0.04702889174222946, 0.015137210488319397, -0.01642116904258728, 0.027615994215011597, 0.01733248308300972, 0.00026093312771990895, 0.02258106879889965, 0.06582344323396683, -0.042469002306461334, -0.11173390597105026, 0.06732060760259628, -0.06934459507465363, -0.06884392350912094, -0.05791132524609566, -0.005068418104201555, -0.024581024423241615, -0.0044455816969275475, 0.015486667864024639, 0.004548688419163227, -0.018383199349045753, 0.11193714290857315, -0.004555965773761272, -0.08139588683843613, 0.04516010731458664, -0.05735396593809128, -0.04257449135184288, 0.0005990997306071222, -0.046375345438718796, -0.008230446837842464, 0.020144417881965637, 0.0059853848069906235, 0.013010076247155666, -0.05254010483622551, -0.07519862800836563, 0.009727700613439083, 0.03071066550910473, -0.044796671718358994, 0.020360000431537628, 0.015275235287845135, 0.03549494221806526, 0.021207503974437714, -0.1014658585190773, 0.0190188717097044, -0.06742310523986816, -0.057044003158807755, -0.019276509061455727, -0.04215581342577934, -0.05408594012260437, -0.04758274182677269, -0.00013287257752381265, 0.054082274436950684, -0.0028435837011784315, -0.020577749237418175, -0.05982081592082977, -0.0005049186875112355, 0.014887345023453236, -0.024199075996875763, -0.009718373417854309, -0.049478478729724884, 0.005973394960165024, 0.0034202798269689083, -0.007460524793714285, -0.04559929296374321, -0.005376853514462709, 0.03389918804168701, 0.0721607580780983, 0.0017962130950763822, -0.04455088824033737, -0.01892409473657608, -0.011683294549584389, 0.023435350507497787, -0.027693649753928185, -0.033692095428705215, 0.028058044612407684, 0.026501189917325974, 0.01178796123713255, 0.047425758093595505, -0.015447813086211681, -0.010972384363412857, -0.034415170550346375, -0.042891837656497955, 0.05722939223051071, 0.019640633836388588, 0.04145006090402603, 0.04957832396030426, 0.007524219341576099, -0.06957818567752838, -0.0008897307561710477, 0.007870981469750404, 0.006730317138135433, -0.020550258457660675, 0.06378646939992905, 0.06759555637836456, 0.08105164766311646, 0.0001822634949348867, -0.017675787210464478, -0.013019928708672523, 0.0007299310527741909, 0.10420505702495575, -0.032142095267772675, 0.07303668558597565, -0.06103748828172684, -0.02217378094792366, 0.03871537744998932, -0.07379862666130066, -0.02787116728723049, -0.033828139305114746, 0.044977158308029175, 0.018305376172065735, -0.01113161537796259, -0.03932162746787071, -0.058625224977731705, -0.012787645682692528, -0.03806305304169655, -0.031112225726246834, 0.052655551582574844, -0.053056441247463226, -0.04920252785086632, -0.02876467816531658, 0.04099337384104729, 0.1085202544927597, -0.046200502663850784, -0.04904145747423172, 0.030150290578603745, 0.050602804869413376, -0.06897740811109543, 0.020799724385142326, -0.011425170116126537, -0.06633755564689636, 0.012236304581165314, -0.014187341555953026, -0.018941150978207588, 0.00790154468268156, -0.048744529485702515, -0.003273185808211565, 0.02386031299829483, -0.021048689261078835, 0.037862759083509445, -0.044652264565229416, 0.04243354871869087, -0.017111266031861305, -0.026145223528146744, 0.01103117223829031, 0.007392780855298042, 0.02158023603260517, -0.014613405801355839, -0.04124410077929497, -0.04492463171482086, 0.03642059117555618, 0.016207240521907806, 0.04192011058330536, 0.040974125266075134, 0.03742466866970062, -0.00015850545605644584, -0.03825705870985985, -0.09224245697259903, 0.0030362484976649284, 0.02569693513214588, -0.08117269724607468, 0.02834577113389969, 0.04093031585216522, 0.022870192304253578, 0.018940256908535957, 0.002439420437440276, 0.047088585793972015, 0.06335173547267914, -0.05057254433631897, 0.031578149646520615, -0.002570477081462741, 0.059264570474624634, -0.0057051233015954494, -0.006268859840929508, -0.05841172859072685, 0.028080902993679047, -0.025523848831653595, 0.0362890250980854, 0.0320393368601799, -0.07053038477897644, -0.02851344272494316, 0.058451808989048004, -0.05097058042883873, 0.019530752673745155, -0.06847961246967316, -0.0007761414162814617, 0.006174212787300348, -0.07090012729167938, -0.018045177683234215, 0.08087936043739319, -0.023641005158424377, -0.09882286190986633, 0.05323340371251106, 0.0029683467000722885, 0.032937079668045044, -0.03764037415385246, 0.008188165724277496, 0.017913127318024635, -0.023084739223122597, -0.0761280283331871, 0.028767403215169907, 0.040400441735982895, 0.050886765122413635, 0.03370431065559387, 0.036727603524923325, -0.08515138924121857, -0.04299111291766167, 0.02282540500164032, -0.02177324704825878, 0.0009864887688308954, -0.04507523030042648, -0.04671624302864075, 0.043369781225919724, -0.015434757806360722, -0.04966071993112564, 0.07331083714962006, -0.0023599208798259497, -0.012553682550787926, -0.008157753385603428, -0.028072083368897438, -0.005701030604541302, 0.08882438391447067, 0.053635284304618835, 0.04829275608062744, -0.040236037224531174, -0.027526848018169403, 0.03523276001214981, 0.02385708875954151, -0.022566452622413635, 0.007232764735817909, -0.04409866780042648, -0.07203639298677444, -0.029431361705064774, 0.0680869072675705, 0.052829086780548096, -0.10825903713703156, -0.02876758761703968, 0.0064940364100039005, -0.02177567034959793, -0.004196728579699993, 0.018862932920455933, 0.03616752848029137, -0.0590689517557621, -0.0433395579457283, 0.0011215605773031712, 0.036331724375486374, -0.009288039058446884, -0.05643735080957413, 0.02403060905635357, 0.017240121960639954, 0.004624310415238142, 0.009895063005387783, -0.07083792984485626, 0.019955724477767944, 0.047900598496198654, -0.056020088493824005, 0.011958586983382702, 0.04691995307803154, -0.03271235525608063, -0.015397854149341583, -0.0289218258112669, 0.0370352566242218, 0.04632611945271492, 0.029461510479450226, -0.04135711118578911, 0.036428965628147125, 0.03650208190083504, 0.005487455055117607, -0.024514202028512955, -0.05257470905780792, -0.01091132964938879, 0.057847097516059875, -0.023556074127554893, 0.033139076083898544, 0.03966095671057701, -0.02258354239165783, 0.03011075221002102, 0.0351644828915596, 0.04762423038482666, 0.022125305607914925, 0.012260823510587215, 0.008590775541961193, 0.04442327097058296, 0.05322038382291794, -0.06375683099031448, 0.03870585188269615, -0.006514312699437141, -0.012263776734471321, 0.05070256069302559, -0.018826773390173912, 0.049843572080135345, -0.01057433895766735, 0.024887332692742348, 0.012627480551600456, -0.06673839688301086, -0.03069479763507843, -0.059948135167360306, 0.06853717565536499, 0.03355032950639725, 0.007386333774775267, -0.04448815807700157, 0.016876371577382088, -0.06981499493122101, 0.012526513077318668, 0.03773735463619232, -0.007095079403370619, 0.012731779366731644, 0.03960394859313965, 0.003847804618999362, 0.05628346651792526, -0.08236242085695267, -0.0461270734667778, -0.04434366896748543, -0.02339676022529602, 0.07793894410133362, -0.010614123195409775, 0.021799352020025253, 0.03863029554486275, -0.0034765193704515696, -0.07895978540182114, 0.011747441254556179, 0.0010710086207836866, -0.006651747040450573, 0.009161731228232384, -0.03577885031700134, -0.018535975366830826, -0.00559514993801713, 0.08517710864543915, -0.055993493646383286, -0.0399080254137516, -0.01721586100757122, 0.038109153509140015, 0.03576254844665527, 0.056676361709833145, -0.01545413862913847, -0.09045404940843582, 0.03626187890768051, 0.043724145740270615, -0.054268304258584976, 0.027838120236992836, 0.06178401783108711, -0.10865883529186249, -0.028860654681921005, 0.014796902425587177, 0.08621738851070404, -0.09908469766378403, -0.059370651841163635, -0.02906009927392006, 0.008618206717073917, 0.06454169005155563, 0.08791595697402954, 0.019664354622364044, 0.025324439629912376, 0.034898027777671814, 0.026080336421728134, 0.04792341589927673, -0.04491843655705452, 0.11345675587654114, 0.05714528635144234, -0.040742456912994385, -0.05692095682024956, -0.019982464611530304, 0.06083342060446739, -0.09731325507164001, 0.012627626769244671, 0.04144284129142761, -0.052818041294813156, 0.007899042218923569, 0.011590112000703812, 0.04966282099485397, -0.022195981815457344, -0.06610275059938431, 0.0025052803102880716, 0.010654102079570293, 0.02787197008728981, 0.061267342418432236, 0.013930529356002808, -0.0520283505320549, -0.0848206877708435, -0.006130702793598175, 0.005688381846994162, -0.03189413249492645, -0.04080034792423248, -0.04882073029875755, 0.01266445405781269, 0.10212920606136322, -0.03542857989668846, 0.014588618651032448]
                            ],
                             
                            "weights": [
                                0.2
                            ]
                        }
                    }
                }
            },
            
            "model_decoder_head": [
                {
                    "ktf.models.components.GraphNodeClassifyHead": {
                        "num_classes": null
                    }
                },

                {
                    "ktf.models.Row": {
                        "layers": [
                            {
                                "tf.keras.layers.Dense": {
                                    "units": 84,
                                    "activation": null
                                }
                            },
                            {
                                "tf.keras.layers.Dense": {
                                    "units": 512,
                                    "activation": "tanh"
                                }
                            },
                            {
                                "tf.keras.layers.Dense": {
                                    "units": 512,
                                    "activation": "tanh"
                                }
                            },
                            {
                                "tf.keras.layers.Dense": {
                                    "units": 512,
                                    "activation": "tanh"
                                }
                            },
                            {
                                "tf.keras.layers.Dense": {
                                    "units": 32,
                                    "activation": null
                                }
                            }
                        ],
                        "broadcast_inputs": true,
                        "flatten_outputs": true
                    }
                }
            ],
        
            "model_readout_head": [
                {
                    "ktf.models.components.GraphReadoutSum": {
                        "use_mean": true
                    }
                },

                {
                    "tf.keras.layers.Dense": {
                        "units": 200,
                        "activation": "tanh"
                    }
                }
            ],
            
            "model_gcn": {
                "ktf.models.networks.RecurrentCGN": {
                    "name": "gcn",
                    "layers": [
                        2,
                        2,
                        2,
                        2,
                        2,
                        2,
                        2
                    ],
                    "debug_self_loops": null,
                    "num_prelim_blocks": 2,
                    "hidden_base_feature_size": 128,
                    "output_feature_size": 768,
                    "use_residuals": true,
                    "aggregator": "gat_gated",
                    "normalization": "batch",
                    "recurrent_cell": "lstm",
                    "aggregator_activation": "relu",
                    "recurrent_activation": "tanh",
                    "dropout": 0.0
                }
            },
            
            "model_tower": {
                "ktf.models.Sequential": {
                    "name": "tower",
                    "layers": [
                        "${self.get_cache('model_gcn')}",

                        {
                            "ktf.models.Row": {
                                "broadcast_inputs": true,
                                "flatten_outputs": true,
                                "layers": [
                                    {
                                        "ktf.models.Sequential": {
                                            "layers": "${self.get_cache('model_decoder_head')}"
                                        }
                                    },

                                    {
                                        "ktf.models.Sequential": {
                                            "layers": "${self.get_cache('model_readout_head')}"
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            },

            "model_decode_tower": {
                "ktf.models.Sequential": {
                    "name": "tower",
                    "layers": [
                        "${self.get_cache('model_gcn')}",

                        {
                            "ktf.models.Sequential": {
                                "layers": "${self.get_cache('model_decoder_head')}"
                            }
                        }
                    ]
                }
            },

            "model_simple_tower": {
                "ktf.models.Sequential": {
                    "name": "tower",
                    "layers": [
                        "${self.get_cache('model_gcn')}",

                        {
                            "ktf.models.Sequential": {
                                "layers": "${self.get_cache('model_readout_head')}"
                            }
                        }
                    ]
                }
            },
            
            "model_simple": {
                "ktf.models.Sequential": {
                    "layers": [
                        {
                            "ktf.models.Row": {
                                "broadcast_inputs": false,
                                "flatten_outputs": true,
                                "name": "tower_row",
                                "layers": [
                                    "${self.get_cache('model_simple_tower')}",
                                    "${self.get_cache('model_simple_tower')}"
                                ]
                            }
                        },
                        {
                            "ktf.models.Sequential": {
                                "layers": [
                                    {
                                        "tf.keras.layers.Dot": {
                                            "axes": -1,
                                            "normalize": true
                                        }
                                    },
                                    {
                                        "tf.keras.layers.ReLU": {
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            },
            
            "model": {
                "ktf.models.Sequential": {
                    "layers": [
                        {
                            "ktf.models.Row": {
                                "broadcast_inputs": false,
                                "flatten_outputs": true,
                                "name": "tower_row",
                                "layers": [
                                    "${self.get_cache('model_tower')}",
                                    "${self.get_cache('model_tower')}"
                                ]
                            }
                        },
                 
                        {
                            "ktf.models.components.Swizzle": {
                                "ordering": [[5, 11], [0, 1, 2, 3, 4, 6, 7, 8, 9, 10]]
                            }
                        },
                        
                        {
                            "ktf.models.Row": {
                                "flatten_outputs": true,
                                "layers": [
                                    {
                                        "ktf.models.Sequential": {
                                            "layers": [
                                                {
                                                    "tf.keras.layers.Dot": {
                                                        "axes": -1,
                                                        "normalize": true
                                                    }
                                                },
                                                {
                                                    "tf.keras.layers.ReLU": {
                                                    }
                                                }
                                            ]
                                        }
                                    },

                                    null
                                ]
                            }
                        }
                    ]
                }
            }
        },
        
        "datasets": {        
            "ktf.datasets.web.commoncrawl.from_tfrecord_graph_unsupervised_pairs": {
                "tfrecord_dir": "/hpc-datasets/web/commoncrawl/tfrecord/CC-MAIN-2008-2009/unsuper_pair_200/**",
                "config_path": "/hpc-datasets/web/commoncrawl/tfrecord/CC-MAIN-2008-2009/unsuper_pair_200/config.json",
                "permute_ratio": 0.5,
                "tag_feature_list": ["tag_type", "text.embedding", "id_attr", "class_attr", "tag_child_pos"],
                "validation_split": 0.10,
                "batch_size": 32,
                "shuffle_size": 800,
                "max_num_nodes": 8,
                "use_node_list": true,
                "debug_force_cache": false,
                "prob_mask": 0.8
            }           
        },
        
        "model": "${self.get_cache('model')}",
       
         "loss": [
            {
                "ktf.models.losses.BinaryCrossentropyW": {
                    "from_logits": false,
                    "label_smoothing": 0.00,
                    "class_weights": [1.0, 1.0]
                }
            },
            
            {
                "tf.keras.losses.CategoricalCrossentropy": {
                    "from_logits": true
                }
            },
            {
                "ktf.models.losses.weighted_loss_wrap": {
                    "keras_loss_class": "${tf.keras.losses.CosineSimilarity}",
                    "sample_weight_fn": "${self.get_cache('value_matched_weights')}"
                }
            },
            {
                "ktf.models.losses.weighted_loss_wrap": {
                    "keras_loss_class": "${tf.keras.losses.CosineSimilarity}",
                    "sample_weight_fn": "${self.get_cache('value_matched_weights')}"
                }
            },
            {
                "ktf.models.losses.weighted_loss_wrap": {
                    "keras_loss_class": "${tf.keras.losses.CosineSimilarity}",
                    "sample_weight_fn": "${self.get_cache('value_matched_weights')}"
                }
            },
            {
                "tf.keras.losses.CategoricalCrossentropy": {
                    "from_logits": true
                }
            },
            
            {
                "tf.keras.losses.CategoricalCrossentropy": {
                    "from_logits": true
                }
            },
            {
                "ktf.models.losses.weighted_loss_wrap": {
                    "keras_loss_class": "${tf.keras.losses.CosineSimilarity}",
                    "sample_weight_fn": "${self.get_cache('value_matched_weights')}"
                }
            },
            {
                "ktf.models.losses.weighted_loss_wrap": {
                    "keras_loss_class": "${tf.keras.losses.CosineSimilarity}",
                    "sample_weight_fn": "${self.get_cache('value_matched_weights')}"
                }
            },
            {
                "ktf.models.losses.weighted_loss_wrap": {
                    "keras_loss_class": "${tf.keras.losses.CosineSimilarity}",
                    "sample_weight_fn": "${self.get_cache('value_matched_weights')}"
                }
            },
            {
                "tf.keras.losses.CategoricalCrossentropy": {
                    "from_logits": true
                }
            }
        ],
        
        "loss_weights": [
            0.0,
            
            1.5,
            4.0,
            0.35,
            1.0,
            1.0,
            
            1.5,
            4.0,
            0.35,
            1.0,
            1.0
        ],
        
        "metrics": [
            [
                {
                    "tf.keras.metrics.BinaryAccuracy": {}
                }
            ], 
            [
                {
                    "tf.keras.metrics.CategoricalAccuracy": { "name": "tag_acc" }
                }
            ],
            [
                {
                    "tf.keras.metrics.CosineSimilarity": { "name": "text" }
                }
            ],
            [
                {
                    "tf.keras.metrics.CosineSimilarity": { "name": "id" }
                }
            ],
            [
                {
                    "tf.keras.metrics.CosineSimilarity": { "name": "class" }
                }
            ],
            [
                {
                    "tf.keras.metrics.CategoricalAccuracy": { "name": "child_acc" }
                }
            ],
            
            [
                {
                    "tf.keras.metrics.CategoricalAccuracy": { "name": "tag_acc" }
                }
            ],
            [
                {
                    "tf.keras.metrics.CosineSimilarity": { "name": "text" }
                }
            ],
            [
                {
                    "tf.keras.metrics.CosineSimilarity": { "name": "id" }
                }
            ],
            [
                {
                    "tf.keras.metrics.CosineSimilarity": { "name": "class" }
                }
            ],
            [
                {
                    "tf.keras.metrics.CategoricalAccuracy": { "name": "child_acc" }
                }
            ]         
        ],
     
        "optimizer": {
            "tfa.optimizers.AdamW": {
                "learning_rate": 0.0011,
                "weight_decay": 0.0
            }
        },
        "train_loop": {
            "ktf.train.KerasTrainLoop": {
                "num_epochs": 200,
                "valid_freq": "${list(range(60, 200, 2))}",
                "callbacks": [
                    {
                        "tf.keras.callbacks.ModelCheckpoint": {
                            "filepath": "/temp-data/unsuper_pair_decode.h5",
                            "monitor": "val_output_3_text",
                            "save_best_only": true,
                            "save_weights_only": true,
                            "mode": "max",
                            "verbose": 1
                        }
                    }
                ],
                "save_dir": null
            }
        }
    }
 
]

