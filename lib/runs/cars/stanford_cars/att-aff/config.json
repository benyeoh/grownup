[
    {
        "datasets": {
            "ktf.datasets.process_chain": {
                "input": {
                    "ktf.datasets.join": {
                        "dataset_tuples": [
                            {
                                "ktf.datasets.cars.stanford_cars.from_tfrecord": {
                                    "stanford_car_tfrecord_dir": "/hpc-datasets/cars/stanford_car/original_kaggle/tfrecord_448_resize_without_pad/train",
                                    "validation_split": 0,
                                    "shuffle_size": 8144,
                                    "batch_size": 64,
                                    "convert_to_float": false
                                }
                            },
                            {
                                "ktf.datasets.cars.stanford_cars.from_tfrecord": {
                                    "stanford_car_tfrecord_dir": "/hpc-datasets/cars/stanford_car/original_kaggle/tfrecord_448_resize_without_pad/test",
                                    "validation_split": 0,
                                    "batch_size": 512
                                }
                            }
                        ]
                    }
                },
                "0": [
                    {
                        "ktf.datasets.process.Unbatch": {}
                    },
                    {
                        "ktf.datasets.process.Albumentations": {
                            "is_batched": false,
                            "is_deterministic": false,
                            "composition": {
                                "albumentations.Compose": {
                                    "transforms": [
                                        {
                                            "albumentations.HorizontalFlip": {
                                                "p": 0.5
                                            }
                                        },
                                        {
                                            "albumentations.OneOf": {
                                                "p": 0.25,
                                                "transforms": [
                                                    {
                                                        "albumentations.GaussNoise": {
                                                            "p": 1.0,
                                                            "var_limit": "${(20.0, 70.0)}"
                                                        }
                                                    },
                                                    {
                                                        "albumentations.IAAAdditiveGaussianNoise": {
                                                            "p": 1.0,
                                                            "scale": "${(10.0, 30.0)}"
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            "albumentations.OneOf": {
                                                "p": 0.25,
                                                "transforms": [
                                                    {
                                                        "albumentations.MotionBlur": {
                                                            "p": 0.3
                                                        }
                                                    },
                                                    {
                                                        "albumentations.Blur": {
                                                            "p": 0.4,
                                                            "blur_limit": 9
                                                        }
                                                    },
                                                    {
                                                        "albumentations.Downscale": {
                                                            "p": 0.4
                                                        }
                                                    },
                                                    {
                                                        "albumentations.IAASharpen": {
                                                            "p": 0.3
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            "albumentations.ShiftScaleRotate": {
                                                "p": 0.5,
                                                "rotate_limit": 11,
                                                "shift_limit": 0.15,
                                                "scale_limit": 0.1
                                            }
                                        },
                                        {
                                            "albumentations.OneOf": {
                                                "p": 0.5,
                                                "transforms": [
                                                    {
                                                        "albumentations.RandomBrightnessContrast": {
                                                            "p": 1.0,
                                                            "brightness_limit": 0.25,
                                                            "contrast_limit": 0.35
                                                        }
                                                    },
                                                    {
                                                        "albumentations.Equalize": {
                                                            "p": 0.4
                                                        }
                                                    },
                                                    {
                                                        "albumentations.CLAHE": {
                                                            "p": 0.4
                                                        }
                                                    },
                                                    {
                                                        "albumentations.RandomGamma": {
                                                            "p": 1.0
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            "albumentations.OneOf": {
                                                "p": 0.5,
                                                "transforms": [
                                                    {
                                                        "albumentations.RandomBrightnessContrast": {
                                                            "p": 1.0,
                                                            "brightness_limit": 0.25,
                                                            "contrast_limit": 0.35
                                                        }
                                                    },
                                                    {
                                                        "albumentations.Posterize": {
                                                            "p": 0.25
                                                        }
                                                    },
                                                    {
                                                        "albumentations.RGBShift": {
                                                            "p": 0.3
                                                        }
                                                    },
                                                    {
                                                        "albumentations.RandomGamma": {
                                                            "p": 1.0
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            "albumentations.HueSaturationValue": {
                                                "p": 0.5,
                                                "hue_shift_limit": 30,
                                                "sat_shift_limit": 35,
                                                "val_shift_limit": 20
                                            }
                                        },
                                        {
                                            "albumentations.Cutout": {
                                                "p": 0.5,
                                                "num_holes": 6,
                                                "max_h_size": 128,
                                                "max_w_size": 128
                                            }
                                        }
                                    ],
                                    "p": 1.0
                                }
                            }
                        }
                    },
                    {
                        "ktf.datasets.process.ConvertToImgDtype": {
                            "is_batched": false,
                            "dtype": "${tf.float32}"
                        }
                    },
                    {
                        "ktf.datasets.process.Batch": {
                            "batch_size": 64
                        }
                    },
                    {
                        "ktf.datasets.process.ImgAugmentation": {
                            "horizontal_flip_prob": 0,
                            "random_crop_prob": 0,
                            "central_crop_prob": 0,
                            "standardize_prob": 1,
                            "standardize_mean": [
                                0.485,
                                0.456,
                                0.406
                            ],
                            "standardize_std_dev": [
                                0.229,
                                0.224,
                                0.225
                            ]
                        }
                    }
                ],
                "1": [
                    {
                        "ktf.datasets.process.ImgAugmentation": {
                            "horizontal_flip_prob": 0,
                            "random_crop_prob": 0,
                            "central_crop_prob": 0,
                            "standardize_prob": 1,
                            "standardize_mean": [
                                0.485,
                                0.456,
                                0.406
                            ],
                            "standardize_std_dev": [
                                0.229,
                                0.224,
                                0.225
                            ]
                        }
                    }
                ]
            }
        },
        "model": {
            "ktf.models.networks.AttAffNet": {
                "num_outputs": 196,
                "classifier_model": {
                    "ktf.models.networks.tresnetm": {
                        "pooling": null,
                        "name": "classifier_net"
                    }
                },
                "embedding_dimensions": 1024,
                "use_classifier_only": false,
                "use_att_aff_only": false,
                "name": "attaffnet_whole_tresnetm_nocrop_noscale"
            }
        },
        "loss": [
            {
                "tf.keras.losses.SparseCategoricalCrossentropy": {
                    "from_logits": true
                }
            },
            {
                "ktf.models.losses.EmbeddingLoss": {
                    "num_classes": 196,
                    "feature_dimensions": 1024
                }
            }
        ],
        "loss_weights": [
            1,
            2
        ],
        "metrics": [
            [
                {
                    "tf.keras.metrics.SparseCategoricalAccuracy": {}
                }
            ],
            []
        ],
        "optimizer": {
            "tfa.optimizers.AdamW": {
                "learning_rate": 0.0005,
                "weight_decay": 0.0003
            }
        },
        "train_loop": {
            "ktf.train.KerasTrainLoop": {
                "num_epochs": 310,
                "pretrained_weights": [
                    [
                        "attention_network",
                        "/hpc-datasets/ktf/weights/custom/attaffnet/attnet.h5"
                    ],
                    [
                        "classifier_net",
                        "/hpc-datasets/ktf/weights/custom/tresnetm/imagenet_448/tresnet_448.h5"
                    ]
                ],
                "save_dir": "/hpc-datasets/junwah/ktf/runs/attaff_endtoend_test/",
                "callbacks": [
                    {
                        "tf.keras.callbacks.LearningRateScheduler": {
                            "schedule": {
                                "tf.keras.experimental.CosineDecayRestarts": {
                                    "initial_learning_rate": 0.0005,
                                    "first_decay_steps": 10,
                                    "t_mul": 2,
                                    "m_mul": 0.9
                                }
                            }
                        }
                    },
                    {
                        "ktf.train.callbacks.VarScheduler": {
                            "schedule": {
                                "tf.keras.experimental.CosineDecayRestarts": {
                                    "initial_learning_rate": 0.0003,
                                    "first_decay_steps": 10,
                                    "t_mul": 2,
                                    "m_mul": 0.9
                                }
                            },
                            "var_name": "weight_decay"
                        }
                    },
                    {
                        "tf.keras.callbacks.ModelCheckpoint": {
                            "filepath": "/hpc-datasets/junwah/ktf/runs/attaff_endtoend_test/ckpt/best_val.tf",
                            "monitor": "val_output_1_sparse_categorical_accuracy",
                            "save_best_only": true,
                            "verbose": 1
                        }
                    },
                    {
                        "tf.keras.callbacks.CSVLogger": {
                            "filename": "/hpc-datasets/junwah/ktf/runs/attaff_endtoend_test/training.log"
                        }
                    }
                ]
            }
        }
    }
]
